<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customers Management | Watch Shop</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/admin-sidebar.css">
  <link rel="stylesheet" href="/css/admin-dashboard.css">
  <link rel="stylesheet" href="/css/admin-customers.css">
</head>

<body>
  <%- include('../partials/admin/_sidebar', { activePage: 'customers' }) %>

  <main class="admin-main">
    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h2 class="fw-bold text-dark mb-0">Customer Management</h2>

        <!-- Right: Add button -->
        <div>
          <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            <i class="fas fa-plus me-2"></i> Add New Customer
          </button>
        </div>
      </div>

      <!-- Top controls: left = search + status filter, right = (kept earlier) -->
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2">
          <input id="customerSearch" type="text" class="form-control search-input" placeholder="Search by name, email or phone">
          <select id="statusFilter" class="form-select status-filter">
            <option value="All">All Status</option>
            <option value="Active">Active</option>
            <option value="Blocked">Blocked</option>
            <option value="Verified">Verified</option>
          </select>
        </div>

        <!-- Optional right controls (kept empty for now) -->
        <div></div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-header">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Status</th>
                <th>Total Orders</th>
                <th>Last Order</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <% if (customers && customers.length > 0) { %>
                <% customers.forEach((customer, i) => { %>
                  <tr>
                    <td><%= i + 1 %></td>
                    <td><%= customer.name %></td>
                    <td><%= customer.email %></td>
                    <td><%= customer.phone %></td>
                    <td><%= customer.address %></td>
                    <td>
                      <span class="badge <%= customer.status === 'Active' ? 'bg-success' : (customer.status === 'Verified' ? 'bg-primary' : 'bg-danger') %>">
                        <%= customer.status %>
                      </span>
                    </td>

                    <!-- derived values (if you don't have values in dummy data, render dash) -->
                    <td><%= customer.totalOrders ?? '—' %></td>
                    <td><%= customer.lastOrder ?? '—' %></td>

                    <td>
                      <!-- Edit button includes all fields via data-* so edit modal can be prefilled -->
                      <button
                        class="btn btn-sm btn-edit"
                        data-bs-toggle="modal"
                        data-bs-target="#editCustomerModal"
                        data-id="<%= customer._id || '' %>"
                        data-name="<%= customer.name %>"
                        data-email="<%= customer.email %>"
                        data-phone="<%= customer.phone %>"
                        data-address="<%= customer.address %>"
                        data-status="<%= customer.status %>">
                        <i class="fas fa-pen"></i>
                      </button>

                      <form action="/admin/customers/delete/<%= customer._id %>" method="POST" class="d-inline">
                        <button class="btn btn-sm btn-delete" type="submit">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="9" class="text-center text-muted py-4">No customers found</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="addCustomerModalLabel">Add New Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form action="/admin/customers/add" method="POST">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" class="form-control" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input type="text" name="phone" class="form-control" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select" required>
                  <option value="Active">Active</option>
                  <option value="Verified">Verified</option>
                  <option value="Blocked">Blocked</option>
                </select>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label">Address</label>
                <textarea name="address" class="form-control" rows="2" required></textarea>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-save w-100" type="submit">Save Customer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="editCustomerModalLabel">Edit Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="editCustomerForm" action="/admin/customers/edit" method="POST">
          <div class="modal-body">
            <input type="hidden" name="id" id="editCustomerId">

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" id="editName" class="form-control" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" id="editEmail" class="form-control" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Phone</label>
                <input type="text" name="phone" id="editPhone" class="form-control" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Status</label>
                <select name="status" id="editStatus" class="form-select" required>
                  <option value="Active">Active</option>
                  <option value="Verified">Verified</option>
                  <option value="Blocked">Blocked</option>
                </select>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label">Address</label>
                <textarea name="address" id="editAddress" class="form-control" rows="2" required></textarea>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-save w-100" type="submit">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- small script: prefill edit modal and set action -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const editModal = document.getElementById('editCustomerModal');
      if (!editModal) return;

      editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        const id = button.getAttribute('data-id') || '';
        const name = button.getAttribute('data-name') || '';
        const email = button.getAttribute('data-email') || '';
        const phone = button.getAttribute('data-phone') || '';
        const address = button.getAttribute('data-address') || '';
        const status = button.getAttribute('data-status') || 'Active';

        // fill fields
        document.getElementById('editCustomerId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editEmail').value = email;
        document.getElementById('editPhone').value = phone;
        document.getElementById('editAddress').value = address;
        document.getElementById('editStatus').value = status;

        // update form action to include id (if you prefer URL param)
        const form = document.getElementById('editCustomerForm');
        form.action = `/admin/customers/edit/${id}`;
      });

      // Optional: client-side filtering (search + status). Not required, but helpful on big lists.
      const searchInput = document.getElementById('customerSearch');
      const statusFilter = document.getElementById('statusFilter');

      function applyClientFilter() {
        const q = searchInput.value.trim().toLowerCase();
        const st = statusFilter.value;
        const rows = document.querySelectorAll('table tbody tr');

        rows.forEach(row => {
          // skip placeholder "no results" row
          if (row.querySelectorAll('td').length === 1) return;
          const text = row.textContent.toLowerCase();
          const statusText = row.querySelector('td:nth-child(6)').innerText.trim();

          const matchSearch = q === '' || text.includes(q);
          const matchStatus = st === 'All' || statusText.toLowerCase() === st.toLowerCase();

          row.style.display = (matchSearch && matchStatus) ? '' : 'none';
        });
      }

      if (searchInput) searchInput.addEventListener('input', applyClientFilter);
      if (statusFilter) statusFilter.addEventListener('change', applyClientFilter);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
