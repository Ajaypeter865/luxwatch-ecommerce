<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Coupons Management | Watch Shop</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/css/admin-sidebar.css">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/coupon.css">
</head>

<body>

    <%- include('../partials/user/_toastify', { success: success, error: error }) %>
        <%- include('../partials/admin/_sidebar', { activePage: 'coupons' }) %>

            <main class="admin-main">
                <div class="container-fluid p-4">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="fw-bold page-title">Coupons Management</h2>

                        <button class="btn btn-theme" data-bs-toggle="modal" data-bs-target="#addCouponModal">
                            + Add Coupon
                        </button>
                    </div>

                    <!-- Coupon Table -->
                    <div class="card coupon-card shadow-sm">
                        <div class="card-header fw-bold">All Coupons</div>

                        <div class="table-responsive">
                            <table class="table table-striped align-middle text-center mb-0">
                                <thead>
                                    <tr>
                                        <th style="width:4%;">#</th>
                                        <th style="width:28%;">Code</th>
                                        <th style="width:18%;">Discount</th>
                                        <th style="width:18%;">Expiry</th>
                                        <th style="width:12%;">Status</th>
                                        <th style="width:20%;">Actions</th>
                                    </tr>
                                </thead>

                                <tbody id="couponTableBody">
                                    <% coupons.forEach((c, index)=> { %>
                                        <tr>
                                            <td>
                                                <%= index + 1 %>
                                            </td>
                                            <td class="fw-semibold">
                                                <%= c.code %>
                                            </td>
                                            <td>
                                                <%= c.discountValue %>%
                                            </td>
                                            <td>
                                                <%= c.expiryDate.toISOString().split('T')[0] %>
                                            </td>

                                            <td>
                                                <% if (c.active) { %>
                                                    <span class="badge status-active">Active</span>
                                                    <% } else { %>
                                                        <span class="badge status-blocked">Blocked</span>
                                                        <% } %>
                                            </td>

                                            <td>
                                                <button class="btn btn-outline-theme btn-sm edit-btn"
                                                    data-id="<%= c._id %>" data-code="<%= c.code %>"
                                                    data-discount="<%= c.discountValue %>"
                                                    data-expiry="<%= c.expiryDate.toISOString().split('T')[0] %>"
                                                    data-min="<%= c.minPurchase || 0 %>" data-bs-toggle="modal"
                                                    data-bs-target="#editCouponModal">
                                                    Edit
                                                </button>

                                                <button class="btn btn-outline-danger btn-sm delete-btn"
                                                    data-id="<%= c._id %>">
                                                    Delete
                                                </button>

                                                <% if (c.active) { %>
                                                    <button class="btn btn-outline-secondary btn-sm block-btn"
                                                        data-id="<%= c._id %>">
                                                        Block
                                                    </button>
                                                    <% } else { %>
                                                        <button class="btn btn-outline-success btn-sm unblock-btn"
                                                            data-id="<%= c._id %>">
                                                            Unblock
                                                        </button>
                                                        <% } %>

                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->


                    </div>

                </div>
            </main>


            <!-- Add Coupon Modal -->
            <div class="modal fade" id="addCouponModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Add Coupon</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <form action="/admin/coupon/add" method="POST">
                            <div class="modal-body">

                                <label class="form-label">Coupon Code</label>
                                <input type="text" name="code" class="form-control mb-3" required>

                                <label class="form-label">Discount (%)</label>
                                <input type="number" name="discountValue" class="form-control mb-3" min="1" max="90"
                                    required>

                                <label class="form-label">Expiry Date</label>
                                <input type="date" name="expiryDate" class="form-control mb-3" required>

                                <label class="form-label">Minimum Purchase (₹)</label>
                                <input type="number" name="minPurchase" class="form-control" min="0">
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-theme" type="submit">Save Coupon</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>


            <!-- Edit Coupon Modal -->
            <div class="modal fade" id="editCouponModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Edit Coupon</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <form action="" method="POST">
                            <div class="modal-body">
                                <input type="hidden" name="id">

                                <label class="form-label">Coupon Code</label>
                                <input type="text" name="code" class="form-control mb-3" required>

                                <label class="form-label">Discount (%)</label>
                                <input type="number" name="discountValue" class="form-control mb-3" min="1" max="90"
                                    required>

                                <label class="form-label">Expiry Date</label>
                                <input type="date" name="expiryDate" class="form-control mb-3" required>

                                <label class="form-label">Minimum Purchase (₹)</label>
                                <input type="number" name="minPurchase" class="form-control" min="0">
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-theme" type="submit">Update Coupon</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>


            <!-- JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/js/coupon.js"></script>
            <script>
                const editCouponModal = document.getElementById('editCouponModal');

                editCouponModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;

                    const id = button.getAttribute('data-id');
                    const code = button.getAttribute('data-code');
                    const discount = button.getAttribute('data-discount');
                    const expiry = button.getAttribute('data-expiry');
                    const min = button.getAttribute('data-min');

                    // set form action dynamically
                    const form = editCouponModal.querySelector('form');
                    form.action = `/admin/coupon/edit/${id}`;

                    // populate fields
                    form.querySelector("input[name='id']").value = id;
                    form.querySelector("input[name='code']").value = code;
                    form.querySelector("input[name='discountValue']").value = discount;
                    form.querySelector("input[name='expiryDate']").value = expiry;
                    form.querySelector("input[name='minPurchase']").value = min;
                });
            </script>

            <script>
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const id = this.getAttribute('data-id')
                        if (!confirm('Are you sure you want to delete this coupon?')) return

                        fetch(`/admin/coupon/delete/${id}`, {
                            method: 'DELETE'
                        })

                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    Toastify({
                                        text: "Coupon deleted successfully",
                                        duration: 3000,
                                        gravity: "top",
                                        position: "right",
                                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                                        close: true
                                    }).showToast();

                                    this.closest('tr').remove()

                                } else {
                                    Toastify({
                                        text: "<%= error %>",
                                        duration: 3000,
                                        gravity: "top",
                                        position: "right",
                                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                                        close: true
                                    }).showToast();
                                }
                            })
                    })
                })
            </script>

            <script>
                document.querySelectorAll('.unblock-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        console.log('Hello');

                        const id = this.getAttribute('data-id')


                        fetch(`/admin/coupon/unblock/${id}`, {
                            method: 'PATCH'
                        })

                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    console.log('Hello');

                                    location.reload()
                                }
                            })
                    })
                })

// ---------------------------------------------------------BLOCK COUPON AJAX

                document.querySelectorAll('.block-btn').forEach(btn => {
                    btn.addEventListener('click', function () {

                        const id = this.getAttribute('data-id')


                        fetch(`/admin/coupon/block/${id}`, {
                            method: 'PATCH'
                        })

                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload()
                                }
                            })
                    })
                })
            </script>




</body>

</html>