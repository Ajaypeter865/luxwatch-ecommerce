<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Watch Shop</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/admin-sidebar.css">
  <link rel="stylesheet" href="/css/admin-dashboard.css">

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <%- include('../partials/admin/_sidebar', { activePage: 'dashboard' }) %>

  <main class="admin-main">
    <div class="container-fluid py-4">
      <h2 class="fw-bold mb-4 text-dark">Dashboard</h2>

      <!-- Summary Cards -->
      <div class="row g-4 mb-5">
        <div class="col-md-3">
          <div class="summary-card">
            <h5>Total Sales</h5>
            <h2>₹<%= dashboardData.totalSales.toLocaleString() %></h2>
            <p>This Period</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <h5>Orders</h5>
            <h2><%= dashboardData.totalOrders %></h2>
            <p>Pending: <%= dashboardData.pendingOrders %></p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <h5>Products</h5>
            <h2><%= dashboardData.totalProducts %></h2>
            <p>In Stock</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="summary-card">
            <h5>Customers</h5>
            <h2><%= dashboardData.totalCustomers.toLocaleString() %></h2>
            <p>New: <%= dashboardData.newCustomers %></p>
          </div>
        </div>
      </div>

      <!-- FILTER DROPDOWN -->
      <div class="d-flex justify-content-end mb-3">
        <select id="chartFilter" class="form-select w-auto">
          <option value="weekly">Weekly</option>
          <option value="monthly" selected>Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>

      <!-- CHART SECTION -->
      <div class="row g-4">

        <!-- Line Chart -->
        <div class="col-md-4">
          <div class="p-3 shadow rounded bg-white">
            <h5 class="mb-3">Total Revenue</h5>
            <div class="chart-container">
              <canvas id="lineChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Bar Chart -->
        <div class="col-md-4">
          <div class="p-3 shadow rounded bg-white">
            <h5 class="mb-3">Orders by Category</h5>
            <div class="chart-container">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Pie Chart -->
        <div class="col-md-4">
          <div class="p-3 shadow rounded bg-white">
            <h5 class="mb-3">Revenue by Category</h5>
            <div class="chart-container">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

      </div>

    </div>
  </main>


  <!-- CHART JS SCRIPT -->
  <script>
    // Initial data from backend - with proper defaults
    const lineLabels = <%- JSON.stringify(chartData?.lineLabels || []) %>;
    const lineRevenue = <%- JSON.stringify(chartData?.lineRevenue || []) %>;
    const ordersByCategory = <%- JSON.stringify(chartData?.ordersByCategory || { Manual: 0, 'Limited-Edition': 0, Automatic: 0 }) %>;
    const revenueByCategory = <%- JSON.stringify(chartData?.revenueByCategory || { Manual: 0, 'Limited-Edition': 0, Automatic: 0 }) %>;

    console.log("Chart Data Loaded:");
    console.log("lineLabels:", lineLabels);
    console.log("lineRevenue:", lineRevenue);
    console.log("ordersByCategory:", ordersByCategory);
    console.log("revenueByCategory:", revenueByCategory);

    // Store chart instances globally
    let lineChartInstance, barChartInstance, pieChartInstance;

    // Initialize Line Chart
    function initLineChart() {
      const ctx = document.getElementById("lineChart").getContext("2d");
      lineChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: lineLabels,
          datasets: [{
            label: "Revenue (₹)",
            data: lineRevenue,
            borderColor: "#ff6b6b",
            backgroundColor: "rgba(255, 107, 107, 0.1)",
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: "#ff6b6b"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top"
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return "₹" + value.toLocaleString();
                }
              }
            }
          }
        }
      });
      console.log("Line Chart initialized");
    }

    // Initialize Bar Chart
    function initBarChart() {
      const ctx = document.getElementById("barChart").getContext("2d");
      barChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Manual", "Limited-Edition", "Automatic"],
          datasets: [{
            label: "Number of Orders",
            data: [
              ordersByCategory.Manual || 0,
              ordersByCategory["Limited-Edition"] || 0,
              ordersByCategory.Automatic || 0
            ],
            backgroundColor: ["#4ecdc4", "#44a3df", "#95e1d3"],
            borderColor: ["#2c9b96", "#2a6ba8", "#6cc4b0"],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top"
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
      console.log("Bar Chart initialized");
    }

    // Initialize Pie Chart
    function initPieChart() {
      const ctx = document.getElementById("pieChart").getContext("2d");
      pieChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Manual", "Limited-Edition", "Automatic"],
          datasets: [{
            data: [
              revenueByCategory.Manual || 0,
              revenueByCategory["Limited-Edition"] || 0,
              revenueByCategory.Automatic || 0
            ],
            backgroundColor: ["#ff6b6b", "#ffd93d", "#6bcf7f"],
            borderColor: ["#ff4444", "#ffb700", "#4a9d5f"],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "bottom"
            }
          }
        }
      });
      console.log("Pie Chart initialized");
    }

    // Initialize all charts on page load
    window.addEventListener("DOMContentLoaded", function() {
      console.log("DOM Content Loaded - Initializing charts");
      initLineChart();
      initBarChart();
      initPieChart();
    });

    // Filter Dropdown - Update Charts
    document.getElementById("chartFilter").addEventListener("change", function() {
      const filter = this.value;
      console.log("Filter changed to:", filter);

      fetch(`/admin/chart-data?filter=${filter}`)
        .then(res => {
          console.log("Response status:", res.status);
          return res.json();
        })
        .then(data => {
          console.log("Data received from server:", data);

          // Update Line Chart
          lineChartInstance.data.labels = data.lineLabels;
          lineChartInstance.data.datasets[0].data = data.lineRevenue;
          lineChartInstance.update();

          // Update Bar Chart
          barChartInstance.data.datasets[0].data = [
            data.ordersByCategory.Manual || 0,
            data.ordersByCategory["Limited-Edition"] || 0,
            data.ordersByCategory.Automatic || 0
          ];
          barChartInstance.update();

          // Update Pie Chart
          pieChartInstance.data.datasets[0].data = [
            data.revenueByCategory.Manual || 0,
            data.revenueByCategory["Limited-Edition"] || 0,
            data.revenueByCategory.Automatic || 0
          ];
          pieChartInstance.update();

          console.log("Charts updated successfully");
        })
        .catch(err => console.error("Error updating charts:", err));
    });
  </script>

</body>
</html>