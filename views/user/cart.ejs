<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>My Cart | Watch Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/css/flaticon.css">
    <link rel="stylesheet" href="/css/slicknav.css">
    <link rel="stylesheet" href="/css/animate.min.css">
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/fontawesome-all.min.css">
    <link rel="stylesheet" href="/css/themify-icons.css">
    <link rel="stylesheet" href="/css/slick.css">
    <link rel="stylesheet" href="/css/nice-select.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/cart.css">
</head>

<body>
    <%- include('../partials/user/navbar') %>
    <%- include('../partials/user/_toastify', { success: success, error: error }) %>

    <main>
        <div class="slider-area">
            <div class="single-slider slider-height2 d-flex align-items-center">
                <div class="container">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="hero-cap text-center">
                                <h2>Your Cart</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="cart-section py-5">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">

                        <form id="updateCartForm">
                            <div class="cart-table table-responsive">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (cartItems && cartItems.length> 0) { %>
                                            <% cartItems.forEach(item=> { %>
                                                <tr>
                                                    <td class="cart-product d-flex align-items-center">
                                                        <% 
                                                            // FIX: Check if item.image is an array and get the first element
                                                            let cartItemImageUrl = '/img/default-cart-item.jpg'; // Path to a default image
                                                            
                                                            if (Array.isArray(item.image) && item.image.length > 0) {
                                                                // If item.image is an array (multiple images), use the first one
                                                                cartItemImageUrl = item.image[0];
                                                            } else if (typeof item.image === 'string' && item.image.length > 0) {
                                                                // Fallback for single image stored as a string (if your DB has mixed formats)
                                                                cartItemImageUrl = item.image;
                                                            } 
                                                        %>

                                                        <img src="<%= cartItemImageUrl %>" alt="<%= item.name %>" class="cart-img">
                                                        
                                                        <div class="cart-info">
                                                            <h6>
                                                                <%= item.name %>
                                                            </h6>
                                                        </div>
                                                    </td>

                                                    <td>₹<%= item.price ? item.price.toFixed(2) : "0.00" %>
                                                    </td>

                                                    <td>
                                                        <div class="quantity-control">
                                                            <button class="qty-btn minus" type="button"><i class="ti-minus"></i></button>
                                                            <input type="text" name="quantities[<%= item._id %>]" value="<%= item.quantity %>" class="qty-input" readonly>
                                                            <button class="qty-btn plus" type="button"><i class="ti-plus"></i></button>
                                                        </div>
                                                    </td>

                                                    <td>₹<%= item.total ? item.total.toFixed(2) : "0.00" %>
                                                    </td>

                                                    <td>
                                                        <button type="button" class="btn btn-sm delete-btn" onclick="deleteItem('<%= item._id %>')" title="Remove Item">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>

                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5" class="text-center">Your cart is empty.</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <div class="cart-buttons d-flex justify-content-between">
                                <a href="/shop" class="btn-theme-outline">Continue Shopping</a>
                                <button type="button" class="btn-theme" id="updateCartBtn">Update Cart</button>
                            </div>
                        </form>

                    </div>

                    <div class="col-lg-4">
                        <div class="cart-summary">
                            <h5>Cart Summary</h5>

                            <div class="summary-item d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span>₹<%= totals.subTotal.toFixed(2) %></span>
                            </div>

                            <div class="summary-item d-flex justify-content-between">
                                <span>Shipping:</span>
                                <span>₹<%= totals.shipping.toFixed(2) %></span>
                            </div>

                            <% if (appliedCoupon) { %>
                                <div class="summary-item d-flex justify-content-between align-items-center mt-2 applied-coupon-box">
                                    <span>
                                        <strong>
                                            <%= appliedCoupon.code %>
                                        </strong>
                                        (-<%= appliedCoupon.discountValue %>%)
                                    </span>

                                    <form action="/cart/remove-coupon" method="POST">
                                        <button type="submit" class="remove-coupon-btn">
                                            ✕
                                        </button>
                                    </form>
                                </div>
                            <% } %>

                            <hr>

                            <div class="summary-total d-flex justify-content-between">
                                <strong>Grand Total:</strong>
                                <strong>₹<%= totals.grandTotal.toFixed(2) %></strong>
                            </div>

                            <% if (!appliedCoupon) { %>
                                <form action="/cart/apply-coupon" method="POST" class="coupon-box mt-4">
                                    <input type="text" name="couponCode" class="form-control coupon-input" placeholder="Enter coupon code" required>
                                    <button type="submit" class="btn-theme-outline mt-2 w-100">Apply Coupon</button>
                                </form>
                            <% } %>

                            <div class="checkout-section">
                                <button class="checkout-btn w-100 mt-4" onclick="location.href='/checkout'">
                                    Proceed to Checkout
                                </button>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <%- include('../partials/user/footer') %>

    <script src="/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <script>
        function showNotification(message, type) {
            if (typeof toastr !== 'undefined') {
                type === 'success' ? toastr.success(message) : toastr.error(message);
            } else if (typeof Toastify === 'function') {
                Toastify({
                    text: message,
                    duration: 3000,
                    backgroundColor: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                }).showToast();
            } else {
                // Fallback if no library is loaded
                alert(message);
            }
        }
    </script>

    <script>
        document.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.parentElement.querySelector('.qty-input');
                let value = parseInt(input.value);

                if (this.classList.contains('plus')) {
                    value++;
                } else if (this.classList.contains('minus') && value > 1) {
                    value--;
                }

                input.value = value;
                // Optional: Trigger update immediately if you prefer, otherwise user clicks "Update Cart"
            });
        });
    </script>

    <script>
        document.getElementById("updateCartBtn").addEventListener("click", async function() {
            const btn = this;
            const originalText = btn.innerText;
            
            // 1. Show loading state
            btn.innerText = "Updating...";
            btn.disabled = true;

            const form = document.getElementById("updateCartForm");
            const formData = new FormData(form);
            const quantities = {};

            for (const [key, value] of formData.entries()) {
                if (key.startsWith("quantities[")) {
                    // Extracts ID from quantities[ID]
                    const productId = key.match(/quantities\[(.*)\]/)[1];
                    quantities[productId] = value;
                }
            }

            try {
                const response = await fetch("/cart/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        quantities
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification("Cart updated successfully!", "success");
                    
                    // 2. Reload ONLY after successful response
                    // We add a tiny delay just to let the user see the "Success" toast
                    setTimeout(() => {
                        window.location.reload();
                    }, 500); 
                } else {
                    showNotification(data.message || "Update failed", "error");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error("Error updating cart:", error);
                showNotification("Something went wrong", "error");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>

    <script>
        async function deleteItem(id) {
            if (!confirm("Are you sure you want to remove this item?")) return;

            try {
                // Using DELETE method as per your previous chatGPT script
                const response = await fetch(`/cart/delete/${id}`, {
                    method: "DELETE" // Ensure your backend route expects DELETE
                });

                const data = await response.json();

                if (data.success) {
                    showNotification("Item removed from cart", "success");
                    
                    // Reload page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    showNotification(data.message || "Failed to delete item", "error");
                }
            } catch (err) {
                console.error("Error deleting item:", err);
                showNotification("An error occurred while deleting.", "error");
            }
        }
    </script>

</body>

</html>